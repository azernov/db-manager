# Менеджер базы данных MySQL

Единый интерактивный скрипт для управления базами данных MySQL, который заменяет несколько отдельных скриптов и предоставляет удобный интерфейс для всех операций с БД.

## Возможности

- ✅ **Создание БД** отдельно от создания пользователя
- ✅ **Создание пользователя** с правами доступа к существующей БД
- ✅ **Создание бэкапов** БД с автоматическим именованием
- ✅ **Восстановление БД** из бэкапов
- ✅ **Применение SQL-патчей** с автодополнением файлов
- ✅ **Подключение к БД** в интерактивном режиме
- ✅ **Удаление БД** с двойным подтверждением
- ✅ **Удаление пользователей** с безопасными проверками
- ✅ **Навигация стрелками** в интерактивном меню
- ✅ **Умная конфигурация** с приоритетами и fallback значениями
- ✅ **Многоязычная поддержка** (русский и английский) с автоопределением

## Установка и настройка

### 1. Скачивание проекта

```bash
git clone https://github.com/azernov/db-manager.git
cd db-manager
```

### 2. Конфигурационные файлы

Скрипт использует систему приоритетных конфигураций:

**Приоритет файлов:**
1. `db.conf` - основная конфигурация (высший приоритет, игнорируется в .gitignore)
2. `db.defaults.conf` - дефолтные значения (может быть в репозитории)
3. Встроенные константы - финальный fallback

**Создайте `db.conf`:**
```bash
DBNAME="myproject"
DBUSER="myproject"
DBUSERPASSWORD=""
DBHOST="localhost"
DBPORT="3306"
CHARSET="utf8mb4"
COLLATION="utf8mb4_general_ci"
PATHTOSAVEDB="localdb/"
#MySQL root password (optional, if empty - will prompt for password)
MYSQL_ROOT_PASSWORD=""
```

### 3. Настройка .gitignore

Добавьте в ваш `.gitignore`:
```gitignore
# Database configuration with sensitive data
db/db.conf
```

### 4. Сделайте скрипт исполняемым

```bash
chmod +x db_manager.sh
```

### 5. Языковые настройки

Скрипт поддерживает **автоматическое определение языка** по переменным окружения:
- `LANGUAGE`, `LC_ALL`, `LC_MESSAGES`, `LANG` (в порядке приоритета)
- Поддерживаемые языки: **русский** (`ru`, `be`, `uk`) и **английский** (`en`, по умолчанию)

**Доступные локализации:**
- `locales/ru.sh` - русский язык
- `locales/en.sh` - английский язык

Если автоопределение не работает, скрипт предложит **интерактивный выбор языка** стрелками.

**Принудительная установка языка:**
```bash
# Запуск на русском языке
LANG=ru_RU.UTF-8 ./db_manager.sh

# Запуск на английском языке
LANG=en_US.UTF-8 ./db_manager.sh
```

## Использование

### Интерактивный режим

Запустите без параметров для интерактивного меню:
```bash
./db_manager.sh
```

**Навигация:**
- ↑/↓ - перемещение по меню
- Enter - выбор пункта
- q - выход

### Командный режим

```bash
# Создание только БД
./db_manager.sh --create-db

# Создание пользователя для существующей БД
./db_manager.sh --create-user

# Создание бэкапа
./db_manager.sh --backup

# Восстановление БД
./db_manager.sh --restore

# Применение SQL-патча
./db_manager.sh --patch patch.sql

#     Или через stdin
./db_manager.sh --patch < patch.sql

#     Или через pipe
cat patch.sql | ./db_manager.sh --patch

# Подключение к БД
./db_manager.sh --connect

# Удаление БД (требует подтверждения)
./db_manager.sh --drop-db

# Удаление пользователя (требует подтверждения)
./db_manager.sh --drop-user

# Справка
./db_manager.sh --help
```

## Примеры использования

### Первоначальная настройка проекта

1. **Создайте конфигурацию по умолчанию:**
```bash
# Отредактируйте db.defaults.conf под ваш проект
nano db.defaults.conf
```

2. **Создайте базу данных:**
```bash
./db_manager.sh --create-db
```

3. **Создайте пользователя с доступом к БД:**
```bash
./db_manager.sh --create-user
```

или запустите в интерактивном режиме и выберите соответствующие опции:
```bash
./db_manager.sh
```

4. **Сохраните персональную конфигурацию** (будет предложено в процессе создания)

**Примечание:** Теперь можно создавать БД и пользователя раздельно, что обеспечивает большую гибкость для сложных настроек.

### Резервное копирование

```bash
# Создание бэкапа
./db_manager.sh --backup
# Создаст файлы: actual_db_YYMMDDHHNN.sql и current_db.sql
```

### Восстановление данных

```bash
# Восстановление из последнего бэкапа
./db_manager.sh --restore
# По умолчанию использует current_db.sql
```

### Применение миграций

```bash
# Применение SQL-файла (с автодополнением)
./db_manager.sh --patch migrations/001_create_tables.sql

# через stdin
./db_manager.sh --patch < migrations/001_create_tables.sql

# Применение через pipe
cat migration.sql | ./db_manager.sh --patch

# Через интерактивный режим
./db_manager.sh --patch
```

### Работа с базой данных

```bash
# Подключение к БД в интерактивном режиме
./db_manager.sh --connect
# Откроет mysql клиент с автоматическим подключением
```

## Безопасность

### Root пароль MySQL

**Опция 1: Использование сохраненного пароля**
```bash
# В db.defaults.conf или db.conf
MYSQL_ROOT_PASSWORD="your_root_password"
```

**Опция 2: Ввод пароля при выполнении (рекомендуется)**
```bash
# Оставьте пустым в конфигурации
MYSQL_ROOT_PASSWORD=""
```

### Операции удаления

Все операции удаления требуют **двойного подтверждения**:

1. **Подтверждение намерения:** введите "yes"
2. **Подтверждение объекта:** введите точное название БД/пользователя

**Пример удаления БД:**
```
ВНИМАНИЕ! Вы собираетесь удалить базу данных:
  База данных: myproject
  Хост: localhost:3306

ЭТО ДЕЙСТВИЕ НЕОБРАТИМО! ВСЕ ДАННЫЕ БУДУТ ПОТЕРЯНЫ!

Введите 'yes' для подтверждения удаления: yes
Повторите название базы данных для окончательного подтверждения: myproject
```

## Мерж конфигурации

Скрипт использует умную систему мержа конфигураций:

1. **Загружает `db.defaults.conf`** (базовые значения)
2. **Загружает `db.conf`** (перезаписывает существующие)
3. **Для пустых значений в `db.conf`** - использует из `db.defaults.conf`
4. **Для всё еще пустых значений** - использует встроенные константы

**Пример:**
```bash
# db.defaults.conf
DBNAME="default_project"
DBUSER="default_user"
DBHOST="localhost"

# db.conf
DBNAME="my_project"  # переопределено
DBUSER=""            # пустое - возьмет из defaults
# DBHOST отсутствует  # возьмет из defaults

# Результат:
# DBNAME="my_project"
# DBUSER="default_user"
# DBHOST="localhost"
```

## Структура файлов

После настройки структура каталога:
```
db/
├── db_manager.sh          # Основной скрипт
├── db.defaults.conf       # Дефолтная конфигурация (в git)
├── db.conf               # Персональная конфигурация (в .gitignore)
├── locales/              # Файлы переводов
│   ├── ru.sh             # Русская локализация
│   └── en.sh             # Английская локализация
├── localdb/              # Каталог для бэкапов
│   ├── actual_db_YYMMDDHHNN.sql
│   └── current_db.sql
└── README.md             # Эта документация
```

## Требования

- **MySQL/MariaDB** сервер
- **Bash** 4.0+
- **MySQL клиент** (mysql command)
- **Root доступ** к MySQL серверу

## Поддержка

Скрипт логирует все операции с цветным выводом:
- 🟢 **[INFO]** - успешные операции
- 🟡 **[WARN]** - предупреждения
- 🔴 **[ERROR]** - ошибки
- 🔵 **[DB MANAGER]** - заголовки разделов

Для отладки доступен специальный режим:
```bash
./db_manager.sh --debug-config  # Показывает итоговую конфигурацию
```
